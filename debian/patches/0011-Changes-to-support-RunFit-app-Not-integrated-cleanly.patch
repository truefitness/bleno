From: Mike Nolan <mpnolan@truefitness.com>
Date: Wed, 31 Aug 2016 14:30:44 -0500
Subject: Changes to support RunFit app - Not integrated cleanly

---
 bleno/lib/hci-socket/gap.js | 25 +++++++++++++++++++++----
 1 file changed, 21 insertions(+), 4 deletions(-)

diff --git a/bleno/lib/hci-socket/gap.js b/bleno/lib/hci-socket/gap.js
index 5738287..03a2763 100644
--- a/bleno/lib/hci-socket/gap.js
+++ b/bleno/lib/hci-socket/gap.js
@@ -38,6 +38,8 @@ Gap.prototype.startAdvertising = function(name, serviceUuids) {
   if (name && name.length) {
     scanDataLength += 2 + name.length;
   }
+  // mpn: Add mfg data length to size
+  scanDataLength += 1 + 1 + 3; // length + packet type + data
 
   if (serviceUuids && serviceUuids.length) {
     for (i = 0; i < serviceUuids.length; i++) {
@@ -86,7 +88,8 @@ Gap.prototype.startAdvertising = function(name, serviceUuids) {
     advertisementData.writeUInt8(1 + 16 * serviceUuids128bit.length, advertisementDataOffset);
     advertisementDataOffset++;
 
-    advertisementData.writeUInt8(0x06, advertisementDataOffset);
+    //advertisementData.writeUInt8(0x06, advertisementDataOffset);
+    advertisementData.writeUInt8(0x07, advertisementDataOffset); // mpn: Changed to 0x07 for Complete List of UUIDs
     advertisementDataOffset++;
 
     for (i = 0; i < serviceUuids128bit.length; i++) {
@@ -96,14 +99,28 @@ Gap.prototype.startAdvertising = function(name, serviceUuids) {
   }
 
   // name
+  var scanDataOffset = 0;
   if (name && name.length) {
     var nameBuffer = new Buffer(name);
 
-    scanData.writeUInt8(1 + nameBuffer.length, 0);
-    scanData.writeUInt8(0x08, 1);
-    nameBuffer.copy(scanData, 2);
+    scanData.writeUInt8(1 + nameBuffer.length, scanDataOffset);
+    scanDataOffset++;
+    //scanData.writeUInt8(0x08, 1);
+    scanData.writeUInt8(0x09, scanDataOffset); // mpn: Changed to 0x09 for Complete Local Name
+    scanDataOffset++;
+    nameBuffer.copy(scanData, scanDataOffset);
+    scanDataOffset += nameBuffer.length;
   }
 
+  // mpn: Add Manufacturer Data - This seems to be essential to being noticed
+  // by the RunFit app. However, the actual MFG ID doesn't seem to matter
+  var mfData = new Buffer([0xcd, 0x01, 0x00]);
+  scanData.writeUInt8(1 + mfData.length, scanDataOffset);
+  scanDataOffset++;
+  scanData.writeUInt8(0xff, scanDataOffset);
+  scanDataOffset++;
+  mfData.copy(scanData, scanDataOffset);
+
   this.startAdvertisingWithEIRData(advertisementData, scanData);
 };
 
